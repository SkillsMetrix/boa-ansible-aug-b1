from fastapi import FastAPI
from pydantic import BaseModel
import subprocess, tempfile, os

app = FastAPI()

class RunRequest(BaseModel):
    inventory_content: str
    playbook_content: str

@app.post("/run-playbook-with-inventory/")
def run_playbook(req: RunRequest):
    # Save inventory
    with tempfile.NamedTemporaryFile(delete=False, suffix=".ini") as inv:
        inv.write(req.inventory_content.encode())
        inv.flush()
        inventory_path = inv.name

    # Save playbook
    with tempfile.NamedTemporaryFile(delete=False, suffix=".yml") as pb:
        pb.write(req.playbook_content.encode())
        pb.flush()
        playbook_path = pb.name

    try:
        cmd = ["ansible-playbook", "-i", inventory_path, playbook_path]
        result = subprocess.run(cmd, capture_output=True, text=True)
        return {
            "stdout": result.stdout,
            "stderr": result.stderr,
            "returncode": result.returncode
        }
    finally:
        os.remove(inventory_path)
        os.remove(playbook_path)
